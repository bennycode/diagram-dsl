<!DOCTYPE html>
<html>
  <head>
    <title>js-sequence-diagrams-dsl</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="bower_components/jQuery/dist/jquery.min.js"></script>
    <script src="bower_components/underscore/underscore-min.js"></script>
    <script src="bower_components/raphael/raphael-min.js"></script>
    <script src="bower_components/js-sequence-diagrams/build/sequence-diagram-min.js"></script>
    <script src="src/js/SequenceDiagramDSL.js"></script>
  </head>
  <body>
    <div id="mySequenceDiagram"></div>
    <button id="saveAsPng">Save as PNG</button>
    <script>
      window.onload = function () {

        var bart = 'Bart';
        var homer = 'Homer';
        var lisa = 'Lisa';
        var marge = 'Marge';

        var diagram = new SequenceDiagram('A Day At The Simpsons', DiagramStyle.handDrawn);
        var element = $('#mySequenceDiagram');

        diagram.sequences = [
          from(bart).lineTo(homer).withText('annoys'),
          from(homer).lineTo(bart).withText('chokes'),
          from(bart).dashTo(lisa).withText('annoys'),
          from(lisa).dashTo(marge).withText('stools at'),
          from(marge).lineTo(bart).withText('gives house arrest').andOpenArrow()
        ];

        diagram.renderTo(element);

        // Save as PNG
        $('#saveAsPng').click(function (event) {
          event.preventDefault();

          // Get dimension
          var svgElement = element.children(0).get(0);
          var svgWidth = svgElement.getBoundingClientRect().width;
          var svgHeight = svgElement.getBoundingClientRect().height;

          var width = Math.ceil(svgWidth);
          var height = Math.ceil(svgHeight);

          // Draw canvas
          var canvas = document.createElement('canvas');
          canvas.id = "CursorLayer";
          canvas.width = width;
          canvas.height = height;
          document.body.appendChild(canvas);

          // Draw SVG on Canvas
          var outer = document.createElement('div');
          outer.appendChild(svgElement.cloneNode(true));
          var xml = outer.innerHTML;
          var unicodeXml = window.btoa(unescape(encodeURIComponent(xml)));

          var image = new Image();
          image.src = 'data:image/svg+xml;base64,' + unicodeXml;
          image.onload = function () {
            var context = canvas.getContext('2d');
            context.fillStyle = "#FFF";
            context.fillRect(0, 0, width, height);
            context.drawImage(image, 0, 0);

            // Download PNG
            var anchor = document.createElement('a');
            anchor.download = "image.png";
            anchor.href = canvas.toDataURL('image/png');
            document.body.appendChild(anchor);
            anchor.click();
          };
        });

      };
    </script>
  </body>
</html>
